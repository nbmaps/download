<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nextbike Stationskarte &amp; Export</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  
  <style>
    /* Import der empfohlenen Schriftart von Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    /* Definition der Farbpalette basierend auf der Nextbike CI */
    :root {
        --nextbike-dark-blue: #003A5D;
        --nextbike-light-blue: #0098FF;
        --background-gray: #F5F7FA;
        --border-gray: #DEE2E6;
        --text-dark: #212529;
        --text-muted: #6C757D;
        --text-light: #FFFFFF;
    }

    * {
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
        background-color: var(--background-gray);
        color: var(--text-dark);
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    header {
        background-color: var(--nextbike-dark-blue);
        color: var(--text-light);
        padding: 16px 24px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 1000;
    }

    h1 {
        font-size: 22px;
        color: var(--text-light);
        margin: 0;
        font-weight: 700;
    }
    
    .wrap {
        display: grid;
        grid-template-columns: 480px 1fr;
        gap: 20px;
        padding: 20px;
        flex-grow: 1;
    }

    .panel {
        background: var(--text-light);
        border: 1px solid var(--border-gray);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        overflow-y: auto;
    }
    
    #map-container {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        overflow: hidden; /* Stellt sicher, dass die Karte innerhalb der abgerundeten Ecken bleibt */
    }

    #map {
        height: 100%;
        width: 100%;
    }

    label {
        display: block;
        font-size: 14px;
        color: var(--text-muted);
        margin: 16px 0 6px;
        font-weight: 600;
    }

    select, input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-gray);
        background: #fff;
        color: var(--text-dark);
        font-size: 16px;
        font-family: 'Inter', sans-serif;
    }
    
    input[type="text"]::placeholder {
        color: #adb5bd;
    }

    button {
        appearance: none;
        border-radius: 8px;
        padding: 12px 16px;
        font-weight: 600;
        cursor: pointer;
        font-family: 'Inter', sans-serif;
        font-size: 16px;
        transition: all 0.2s ease-in-out;
    }

    button.primary {
        background-color: var(--nextbike-light-blue);
        color: var(--text-light);
        border: none;
    }
    
    button.primary:hover {
        background-color: #007fdb; /* Etwas dunkler beim Hover */
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 152, 255, 0.2);
    }
    
    button.ghost {
        background-color: transparent;
        color: var(--nextbike-light-blue);
        border: 2px solid var(--nextbike-light-blue);
    }

    button.ghost:hover {
        background-color: var(--nextbike-light-blue);
        color: var(--text-light);
    }
    
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .hint {
        font-size: 12px;
        color: var(--text-muted);
    }
    
    .status-bar {
        margin-top: 12px;
        font-size: 14px;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--background-gray);
        border: 1px solid var(--border-gray);
        color: var(--text-dark);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
    }
    
    hr {
        border: none;
        border-top: 1px solid var(--border-gray);
        margin: 20px 0;
    }
    
    .spinner {
        border: 3px solid rgba(0,0,0,0.1);
        border-top: 3px solid var(--text-light);
        border-radius: 50%;
        width: 18px;
        height: 18px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 6px;
    }

    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    
    footer {
        text-align: center;
        padding: 20px;
        font-size: 14px;
        color: var(--text-muted);
        background-color: var(--text-light);
        border-top: 1px solid var(--border-gray);
    }
  </style>
</head>
<body>
  <header>
    <h1>Nextbike Stationskarte &amp; Export</h1>
  </header>

  <div class="wrap">
    <section class="panel">
      <label for="countrySelect">1) Land w√§hlen</label>
      <select id="countrySelect"></select>

      <label for="brandSelect">2) Marke/System w√§hlen</label>
      <select id="brandSelect" disabled></select>

      <label for="citySelect">3) Stadt filtern (optional)</label>
      <select id="citySelect" disabled></select>

      <hr>

      <div class="grid">
        <div>
          <label for="fileBase">Dateiname</label>
          <input id="fileBase" type="text" value="nextbike_stations" />
        </div>
        <div>
          <label for="quickFilter">Schnellfilter</label>
          <input id="quickFilter" type="text" placeholder="z.‚ÄØB. ‚ÄûHauptbahnhof‚Äú" />
        </div>
      </div>
      
      <div class="row">
        <button class="primary" id="loadBtn"><span id="loadIcon"></span>üîÑ Stationen laden</button>
        <button class="ghost" id="geojsonBtn" disabled>‚¨áÔ∏è GeoJSON</button>
      </div>

      <div class="status-bar" id="status">Lade Listen‚Ä¶</div>

      <hr>

      <div class="grid">
        <div class="badge">Stationen: <strong id="countStations">‚Äì</strong></div>
        <div class="badge">Zuletzt geladen: <strong id="lastUpdated">‚Äì</strong></div>
      </div>
    </section>

    <section id="map-container">
      <div id="map"></div>
    </section>
  </div>

  <footer>
    Ein Projekt zur Visualisierung und zum Export von Nextbike-Stationsdaten.
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script>
    const $ = sel => document.querySelector(sel);
    const status = msg => { $('#status').textContent = msg; };

    let map, layer, currentGeoJSON = null;
    let countryList = [];
    let rawCountries = [];
    let brandList = [];
    const brandCitiesCache = new Map();

    function initMap(){
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
      map.setView([51.1657, 10.4515], 6); // Angepasster Zoom f√ºr Deutschland-Fokus
      layer = L.geoJSON(null, {
        onEachFeature: (f, l) => {
          const p = f.properties || {};
          l.bindPopup(`<strong>${p.name||'Station'}</strong><br>`+
                      `Fahrr√§der: ${p.num_bikes_available ?? '‚Äì'}<br>`+
                      `Freie Pl√§tze: ${p.num_docks_available ?? '‚Äì'}<br>`+
                      `ID: ${p.station_id}`);
        }
      }).addTo(map);
    }

    function option(value, label){ const o = document.createElement('option'); o.value = value; o.textContent = label; return o; }

    function dedupeCountries(countriesIn){
      const mapC = new Map();
      for(const c of countriesIn){
        const code = (c.country || c.country_code || '').toUpperCase();
        const name = c.country_name || '';
        if(name && code){
            const key = code || name;
            if(!mapC.has(key)) mapC.set(key, { country_code: code, country_name: name });
        }
      }
      let arr = Array.from(mapC.values());
      arr.sort((a,b)=>{ if(a.country_name==='Germany') return -1; if(b.country_name==='Germany') return 1; return (a.country_name||'').localeCompare(b.country_name||''); });
      return arr;
    }

    function buildBrands(dataCountries) {
        const mapB = new Map();
        for (const topLevelObject of dataCountries) {
            const geo_country_code = (topLevelObject.country || '').toUpperCase();
            const geo_country_name = topLevelObject.country_name || '';

            const topLevelDomain = (topLevelObject.domain || '').toLowerCase();
            if (topLevelDomain) {
                const name = topLevelObject.name || `System ${topLevelDomain}`;
                if (!mapB.has(topLevelDomain)) {
                    mapB.set(topLevelDomain, {
                        key: topLevelDomain, domain: topLevelDomain, name: name,
                        country_codes: new Set(), country_names: new Set()
                    });
                }
                const entry = mapB.get(topLevelDomain);
                if (geo_country_code) entry.country_codes.add(geo_country_code);
                if (geo_country_name) entry.country_names.add(geo_country_name);
            }

            if (topLevelObject.cities && topLevelObject.cities.length > 0) {
                for (const city of topLevelObject.cities) {
                    const cityDomain = (city.domain || '').toLowerCase();
                    if (!cityDomain) continue;

                    const name = city.name || city.alias || `System ${cityDomain}`;
                    if (!mapB.has(cityDomain)) {
                        mapB.set(cityDomain, {
                            key: cityDomain, domain: cityDomain, name: name,
                            country_codes: new Set(), country_names: new Set()
                        });
                    }
                    const entry = mapB.get(cityDomain);
                    if (geo_country_code) entry.country_codes.add(geo_country_code);
                    if (geo_country_name) entry.country_names.add(geo_country_name);
                }
            }
        }
        const brands = Array.from(mapB.values());
        brands.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        return brands;
    }

    async function loadLists(){
      status('Systeme werden geladen...');
      try{
        const url = 'https://maps.nextbike.net/maps/nextbike-official.json?list_cities=1&bikes=0';
        const resp = await fetch(url, { cache: 'no-store' });
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        
        if (!data || !data.countries) throw new Error("API-Antwort ist ung√ºltig.");

        rawCountries = data.countries;
        countryList = dedupeCountries(rawCountries);
        brandList = buildBrands(rawCountries);

        const cSel = $('#countrySelect'); cSel.innerHTML = '';
        cSel.appendChild(option('', 'Alle L√§nder (weltweit)'));
        for(const c of countryList){ cSel.appendChild(option(c.country_code, `${c.country_name} (${c.country_code})`)); }
        cSel.value = '';

        refreshBrandSelect();
        status('Bitte Auswahl treffen und Stationen laden.');
      }catch(e){
        console.error(e);
        const errorMsg = 'Fehler beim Laden der System-Listen: ' + e.message;
        status(errorMsg);
        alert(errorMsg + '\n\nBitte Internetverbindung pr√ºfen und Seite neu laden.');
      }
    }

    function refreshBrandSelect(){
      const selValRaw = $('#countrySelect').value || '';
      const countryCode = selValRaw.toUpperCase();
      const bSel = $('#brandSelect');
      let list = brandList;
      if(selValRaw){
        list = brandList.filter(b => b.country_codes.has(countryCode));
      }
      bSel.innerHTML='';
      bSel.appendChild(option('', selValRaw ? 'Alle Marken im Land' : 'Alle Marken (weltweit)'));
      for(const b of list){ bSel.appendChild(option(b.key, `${b.name} Œá ${b.domain}`)); }
      bSel.disabled = false;
      refreshCitySelect();
    }

    async function fetchCitiesForBrand(domain){
      if(brandCitiesCache.has(domain)) return brandCitiesCache.get(domain);
      const url = `https://maps.nextbike.net/maps/nextbike-official.json?domains=${encodeURIComponent(domain)}&bikes=0`;
      const resp = await fetch(url, { cache: 'no-store' });
      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      const out = [];
      for(const co of (data.countries||[])){
        const cc = (co.country || co.country_code || '').toUpperCase();
        for(const city of (co.cities||[])){
          out.push({ uid: city.uid, name: city.name || city.alias || city.city || `#${city.uid}`, country_code: cc });
        }
      }
      const seen = new Set();
      const deduped = out.filter(x=>{ if(seen.has(x.uid)) return false; seen.add(x.uid); return true; });
      brandCitiesCache.set(domain, deduped);
      return deduped;
    }

    async function refreshCitySelect(){
      const brandKey = $('#brandSelect').value;
      const citySel = $('#citySelect');
      const countryCode = ($('#countrySelect').value || '').toUpperCase();
      citySel.innerHTML='';
      citySel.appendChild(option('', '[optional] Alle St√§dte im System'));
      if(!brandKey){ citySel.disabled = true; return; }
      try{
        let items = await fetchCitiesForBrand(brandKey);
        if(countryCode) items = items.filter(c => (c.country_code||'').toUpperCase()===countryCode);
        items.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
        for(const c of items){ citySel.appendChild(option(String(c.uid), c.name)); }
        citySel.disabled = false;
      }catch(e){ console.error(e); citySel.disabled = true; }
    }

    function fcFromNextbike(json){
      const features = [];
      for(const country of (json.countries||[])){
        for(const city of (country.cities||[])){
          const domain = city.domain || '';
          for(const place of (city.places||[])){
            const lat = place.lat, lon = place.lng;
            if(typeof lat !== 'number' || typeof lon !== 'number') continue;
            const props = {
              station_id: String(place.number ?? place.uid ?? ''),
              name: place.name || '',
              address: place.address || '',
              capacity: place.bike_racks ?? null,
              num_bikes_available: place.bikes ?? null,
              num_docks_available: place.free_racks ?? null,
              city_uid: city.uid ?? null,
              city_name: city.name || city.city || city.alias || '',
              domain,
              country_name: country.country_name || ''
            };
            features.push({ type:'Feature', geometry:{ type:'Point', coordinates:[lon, lat] }, properties: props });
          }
        }
      }
      return { type:'FeatureCollection', features };
    }
    
    async function loadData(){
      const loadBtn = $('#loadBtn');
      const loadIcon = $('#loadIcon');
      loadBtn.disabled = true;
      loadIcon.innerHTML = '<span class="spinner"></span>';
      status('Lade Stationen‚Ä¶');
      
      try{
        const countryCode = ($('#countrySelect').value || '').toUpperCase();
        const domain = $('#brandSelect').value;
        const cityUid = $('#citySelect').value;
        let url;

        if(domain){
            if(cityUid){
                url = `https://maps.nextbike.net/maps/nextbike-official.json?city=${encodeURIComponent(cityUid)}&bikes=0`;
            } else {
                url = `https://maps.nextbike.net/maps/nextbike-official.json?domains=${encodeURIComponent(domain)}&bikes=0`;
            }
        } else if(countryCode){
            url = `https://maps.nextbike.net/maps/nextbike-official.json?countries=${encodeURIComponent(countryCode)}&bikes=0`;
        } else {
            url = `https://maps.nextbike.net/maps/nextbike-official.json?bikes=0`;
        }

        const resp = await fetch(url, { cache: 'no-store' });
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        let fc = fcFromNextbike(data);

        const filterTxt = ($('#quickFilter').value||'').trim().toLowerCase();
        if(filterTxt){
          fc = { type:'FeatureCollection', features: fc.features.filter(f => {
            const p = f.properties || {}; const s = `${p.name} ${p.address}`.toLowerCase();
            return s.includes(filterTxt);
          })};
        }

        currentGeoJSON = fc;
        $('#countStations').textContent = fc.features.length;
        $('#lastUpdated').textContent = new Date().toLocaleString('de-DE');
        layer.clearLayers().addData(fc);
        if(fc.features.length > 0){ 
            const bounds = L.geoJSON(fc).getBounds(); 
            if(bounds.isValid()) map.fitBounds(bounds, {padding: [50, 50]}); 
        }
        $('#geojsonBtn').disabled = fc.features.length === 0;
        status(`Fertig. ${fc.features.length} Stationen geladen.`);
      }catch(e){ 
          console.error(e); 
          status('Fehler: '+e.message); 
          $('#geojsonBtn').disabled = true; 
      }
      finally{ 
          loadBtn.disabled = false; 
          loadIcon.innerHTML = '';
      }
    }

    function downloadGeoJSON(){ 
      if(!currentGeoJSON) return; 
      const name = ($('#fileBase').value || 'nextbike_stations').replace(/[^A-Za-z0-9_\-]/g,'_'); 
      const blob = new Blob([JSON.stringify(currentGeoJSON,null,2)], {type:'application/geo+json'}); 
      saveAs(blob, name + '.geojson'); 
    }
    
    window.addEventListener('DOMContentLoaded', () => {
      initMap();
      loadLists();
      $('#countrySelect').addEventListener('change', () => { refreshBrandSelect(); });
      $('#brandSelect').addEventListener('change', () => { refreshCitySelect(); });
      $('#loadBtn').addEventListener('click', loadData);
      $('#geojsonBtn').addEventListener('click', downloadGeoJSON);
    });
  </script>
</body>
</html>
